<!DOCTYPE html>
<html>
<head>
    <title>Automation Coverage Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h1>Automation Coverage</h1>
<div class="sort-controls">
    Sort by:
    <select id="sortField">
        <option value="rank">Default</option>
        <option value="name">Project</option>
        <option value="status">Status</option>
        <option value="total">Total TCs</option>
        <option value="automated">Automated TCs</option>
        <option value="percentage">Automation %</option>
    </select>

    <select id="sortOrder">
        <option value="asc">Asc</option>
        <option value="desc">Desc</option>
    </select>
</div>
<div class="summary-bar">
    {% set counts = {} %}
    {% for p in projects %}
        {% set _ = counts.update({p.status: counts.get(p.status,0)+1}) %}
    {% endfor %}

    {% for k,v in counts.items() %}
        <span class="summary-item {{ k|lower|replace(' ','-') }}">
            {{ k }} {{ v }}
        </span>
    {% endfor %}
</div>

<div class="view-toggle">
    <button id="gridBtn" class="active">⬛⬛</button>
    <button id="listBtn">☰</button>
</div>

<div id="projectContainer">

{% set groups = {} %}
{% for p in projects %}
    {% set _ = groups.setdefault(p.status, []).append(p) %}
{% endfor %}

{% for status, items in groups.items() %}
<div class="status-row" data-status="{{ status }}">

    <div class="status-header {{ status|lower|replace(' ', '-') }}"
         onclick="toggleStatus('{{ status }}')">
        <span class="arrow"></span>
        {{ status }} ({{ items|length }} projects)
    </div>

    <div class="status-content">

        <!-- LIST HEADER (only visible in list view) -->
        <div class="list-header">
            <div class="sortable" data-field="rank"># <span class="sort-arrow"></span></div>
            <div class="sortable" data-field="name">Project <span class="sort-arrow"></span></div>
            <div class="sortable" data-field="status">Status <span class="sort-arrow"></span></div>
            <div class="sortable" data-field="total">Total TCs <span class="sort-arrow"></span></div>
            <div class="sortable" data-field="automated">Automated TCs <span class="sort-arrow"></span></div>
            <div class="sortable" data-field="percentage">Automation % <span class="sort-arrow"></span></div>
        </div>

        <div class="card-container">

        {% for p in items %}
        <div class="card {{ p.status|lower|replace(' ', '-') }}"
             data-rank="{{ p.rank }}"
             data-name="{{ p.name }}"
             data-status="{{ p.status }}"
             data-total="{{ p.total }}"
             data-automated="{{ p.automated }}"
             data-percentage="{{ p.percentage }}">


            <div class="serial">{{ p.rank }}</div>

            <div class="card-content">

                <div class="card-header">
                    <div class="project-title">{{ p.name }}</div>
                    <span class="status {{ p.status|lower|replace(' ', '-') }}">
                        {{ p.status }}
                    </span>
                </div>

                <div class="total">{{ p.total }}</div>
                <div class="automated">{{ p.automated }}</div>

                <div class="metric">
                    <div class="metric-value">{{ p.percentage }}%</div>

                    <div class="list-progress">
                        <div class="list-progress-fill"
                             style="width: {{ p.percentage }}%"></div>
                    </div>
                </div>

                <div class="donut {{ p.status|lower|replace(' ', '-') }}"
                     style="--value: {{ p.percentage }};">
                    <span>{{ p.percentage }}%</span>
                </div>

            </div>
        </div>
        {% endfor %}

        </div>
    </div>
</div>
{% endfor %}

</div>

<script>
function toggleStatus(status) {
    const row = document.querySelector('.status-row[data-status="' + status + '"]');
    if (row) row.classList.toggle("active");
}

document.addEventListener("DOMContentLoaded", () => {
    toggleStatus("At Risk");
});

const gridBtn = document.getElementById("gridBtn");
const listBtn = document.getElementById("listBtn");

gridBtn.onclick = () => {
    document.body.classList.remove("list-view");
    gridBtn.classList.add("active");
    listBtn.classList.remove("active");
};

listBtn.onclick = () => {
    document.body.classList.add("list-view");
    listBtn.classList.add("active");
    gridBtn.classList.remove("active");
};
</script>

<script>
const sortField = document.getElementById("sortField");
const sortOrder = document.getElementById("sortOrder");

function sortWithinGroups() {

    const field = sortField.value;
    const order = sortOrder.value;

    document.querySelectorAll(".status-row").forEach(row => {

        const container = row.querySelector(".card-container");
        const cards = Array.from(container.querySelectorAll(".card"));

        cards.sort((a,b) => {

            let va = a.dataset[field];
            let vb = b.dataset[field];

            if(!isNaN(va) && !isNaN(vb)) {
                va = parseFloat(va);
                vb = parseFloat(vb);
            } else {
                va = va.toLowerCase();
                vb = vb.toLowerCase();
            }

            if(order === "asc") {
                return va > vb ? 1 : -1;
            } else {
                return va < vb ? 1 : -1;
            }
        });

        cards.forEach(c => container.appendChild(c));
    });
}

sortField.onchange = sortWithinGroups;
sortOrder.onchange = sortWithinGroups;
</script>

<script>
let currentSort = { field:null, order:"asc" };

document.querySelectorAll(".sortable").forEach(header => {

    header.onclick = () => {

        const field = header.dataset.field;

        // Toggle direction like Excel
        if(currentSort.field === field){
            currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
            currentSort.field = field;
            currentSort.order = "asc";
        }

        updateSortArrows();
        sortGroups(field, currentSort.order);
    };
});

function updateSortArrows(){

    document.querySelectorAll(".sort-arrow").forEach(a=>a.textContent="");

    const activeHeader =
        document.querySelector('.sortable[data-field="'+currentSort.field+'"]');

    if(activeHeader){
        const arrow = activeHeader.querySelector(".sort-arrow");
        arrow.textContent = currentSort.order === "asc" ? "▲" : "▼";
    }
}

function sortGroups(field, order){

    document.querySelectorAll(".status-row").forEach(row => {

        const container = row.querySelector(".card-container");
        const cards = Array.from(container.querySelectorAll(".card"));

        cards.sort((a,b)=>{

            let va = a.dataset[field];
            let vb = b.dataset[field];

            if(!isNaN(va) && !isNaN(vb)){
                va = parseFloat(va);
                vb = parseFloat(vb);
            } else {
                va = va.toLowerCase();
                vb = vb.toLowerCase();
            }

            if(order==="asc"){
                return va>vb ? 1 : -1;
            }else{
                return va<vb ? 1 : -1;
            }
        });

        cards.forEach(c => container.appendChild(c));
    });
}
</script>

</body>
</html>