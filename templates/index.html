<!DOCTYPE html>
<html>
<head>
    <title>Automation Coverage Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h1>Automation Coverage</h1>
<div class="summary-bar">
    {% set counts = {} %}
    {% for p in projects %}
        {% set _ = counts.update({p.status: counts.get(p.status,0)+1}) %}
    {% endfor %}

    {% for k,v in counts.items() %}
        <span class="summary-item {{ k|lower|replace(' ','-') }}">
            {{ k }} {{ v }}
        </span>
    {% endfor %}
</div>

<div class="view-toggle">
    <button id="gridBtn" class="active">⬛⬛</button>
    <button id="listBtn">☰</button>
</div>

<div id="projectContainer">

{% set groups = {} %}
{% for p in projects %}
    {% set _ = groups.setdefault(p.status, []).append(p) %}
{% endfor %}

{% for status, items in groups.items() %}
<div class="status-row" data-status="{{ status }}">

    <div class="status-header {{ status|lower|replace(' ', '-') }}"
         onclick="toggleStatus('{{ status }}')">
        <span class="arrow"></span>
        {{ status }} ({{ items|length }} projects)
    </div>

    <div class="status-content">

        <!-- LIST HEADER (only visible in list view) -->
        <div class="list-header">
            <div>#</div>
            <div>Project</div>
            <div>Status</div>
            <div>Total TCs</div>
            <div>Automated TCs</div>
            <div>Automation %</div>
        </div>

        <div class="card-container">

        {% for p in items %}
        <div class="card {{ p.status|lower|replace(' ', '-') }}">
            <div class="serial">{{ p.rank }}</div>

            <div class="card-content">

                <div class="card-header">
                    <div class="project-title">{{ p.name }}</div>
                    <span class="status {{ p.status|lower|replace(' ', '-') }}">
                        {{ p.status }}
                    </span>
                </div>

                <div class="total">{{ p.total }}</div>
                <div class="automated">{{ p.automated }}</div>

                <div class="metric">
                    <div class="metric-value">{{ p.percentage }}%</div>

                    <div class="list-progress">
                        <div class="list-progress-fill"
                             style="width: {{ p.percentage }}%"></div>
                    </div>
                </div>

                <div class="donut {{ p.status|lower|replace(' ', '-') }}"
                     style="--value: {{ p.percentage }};">
                    <span>{{ p.percentage }}%</span>
                </div>

            </div>
        </div>
        {% endfor %}

        </div>
    </div>
</div>
{% endfor %}

</div>

<script>
function toggleStatus(status) {
    const row = document.querySelector('.status-row[data-status="' + status + '"]');
    if (row) row.classList.toggle("active");
}

document.addEventListener("DOMContentLoaded", () => {
    toggleStatus("At Risk");
});

const gridBtn = document.getElementById("gridBtn");
const listBtn = document.getElementById("listBtn");

gridBtn.onclick = () => {
    document.body.classList.remove("list-view");
    gridBtn.classList.add("active");
    listBtn.classList.remove("active");
};

listBtn.onclick = () => {
    document.body.classList.add("list-view");
    listBtn.classList.add("active");
    gridBtn.classList.remove("active");
};
</script>

</body>
</html>