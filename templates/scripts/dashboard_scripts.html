<script>
function toggleStatus(status) {
    const row = document.querySelector('.status-row[data-status="' + status + '"]');
    if (row) row.classList.toggle("active");
}

document.addEventListener("DOMContentLoaded", () => {
    toggleStatus("At Risk");
});

const gridBtn = document.getElementById("gridBtn");
const listBtn = document.getElementById("listBtn");

gridBtn.onclick = () => {
    document.body.classList.remove("list-view");
    gridBtn.classList.add("active");
    listBtn.classList.remove("active");
};

listBtn.onclick = () => {
    document.body.classList.add("list-view");
    listBtn.classList.add("active");
    gridBtn.classList.remove("active");
};
</script>

<script>
const sortField = document.getElementById("sortField");
const sortOrder = document.getElementById("sortOrder");

function sortWithinGroups() {

    const field = sortField.value;
    const order = sortOrder.value;

    document.querySelectorAll(".status-row").forEach(row => {

        const container = row.querySelector(".card-container");
        const cards = Array.from(container.querySelectorAll(".card"));

        cards.sort((a,b) => {

            let va = a.dataset[field];
            let vb = b.dataset[field];

            if(!isNaN(va) && !isNaN(vb)) {
                va = parseFloat(va);
                vb = parseFloat(vb);
            } else {
                va = va.toLowerCase();
                vb = vb.toLowerCase();
            }

            if(order === "asc") {
                return va > vb ? 1 : -1;
            } else {
                return va < vb ? 1 : -1;
            }
        });

        cards.forEach(c => container.appendChild(c));
    });
}

sortField.onchange = sortWithinGroups;
sortOrder.onchange = sortWithinGroups;
</script>

<script>
let currentSort = { field:null, order:"asc" };

document.querySelectorAll(".sortable").forEach(header => {

    header.onclick = () => {

        const field = header.dataset.field;

        // Toggle direction like Excel
        if(currentSort.field === field){
            currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
            currentSort.field = field;
            currentSort.order = "asc";
        }

        updateSortArrows();
        sortGroups(field, currentSort.order);
    };
});

function updateSortArrows(){

    document.querySelectorAll(".sort-arrow").forEach(a=>a.textContent="");

    const activeHeader =
        document.querySelector('.sortable[data-field="'+currentSort.field+'"]');

    if(activeHeader){
        const arrow = activeHeader.querySelector(".sort-arrow");
        arrow.textContent = currentSort.order === "asc" ? "â–²" : "â–¼";
    }
}

function sortGroups(field, order){

    document.querySelectorAll(".status-row").forEach(row => {

        const container = row.querySelector(".card-container");
        const cards = Array.from(container.querySelectorAll(".card"));

        cards.sort((a,b)=>{

            let va = a.dataset[field];
            let vb = b.dataset[field];

            if(!isNaN(va) && !isNaN(vb)){
                va = parseFloat(va);
                vb = parseFloat(vb);
            } else {
                va = va.toLowerCase();
                vb = vb.toLowerCase();
            }

            if(order==="asc"){
                return va>vb ? 1 : -1;
            }else{
                return va<vb ? 1 : -1;
            }
        });

        cards.forEach(c => container.appendChild(c));
    });
}
</script>

<script>
const themeBtn = document.getElementById("themeBtn");

function applyTheme(theme){
    document.body.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);

    themeBtn.textContent = theme === "dark" ? "ðŸŒ™ Dark" : "â˜€ï¸ Light";
}

themeBtn.onclick = () => {
    const current = document.body.getAttribute("data-theme") || "dark";
    applyTheme(current === "dark" ? "light" : "dark");
};

// Load saved theme
document.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("theme") || "dark";
    applyTheme(saved);
});

const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const canvas = document.getElementById("orgSummaryChart");
    if (!canvas) return;

    const total = Number({{ org_summary.total_tcs }});
    const automated = Number({{ org_summary.automated_tcs }});
    const percent = Number({{ org_summary.automation_percent }});

    let fillColor = "#52c41a";
    if (percent <= 44) fillColor = "#ff4d4f";
    else if (percent <= 59) fillColor = "#4096ff";

    const targetMarkerPlugin = {
    id: "targetMarker",
    afterDraw(chart){

        const meta = chart.getDatasetMeta(0);
        if(!meta || !meta.data.length) return;

        const arc = meta.data[0];
        const ctx = chart.ctx;

        const cx = arc.x;
        const cy = arc.y;
        const outer = arc.outerRadius;

        const targetPercent = 60;

        const startAngle = -Math.PI/2;
        const totalAngle = Math.PI;
        const angle = startAngle + (totalAngle * (targetPercent/100));

        const markerInner = outer - 6;
        const markerOuter = outer + 16;

        const x1 = cx + Math.cos(angle) * markerInner;
        const y1 = cy + Math.sin(angle) * markerInner;

        const x2 = cx + Math.cos(angle) * markerOuter;
        const y2 = cy + Math.sin(angle) * markerOuter;

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x1,y1);
        ctx.lineTo(x2,y2);
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#000";
        ctx.stroke();
        ctx.restore();
        }
    };

    const chart = new Chart(canvas, {
        plugins:[targetMarkerPlugin],
        type: "doughnut",
        data: {
            datasets: [{
                data: [automated, Math.max(total - automated,0)],
                backgroundColor: [fillColor, "#d9d9d9"],
                hoverBackgroundColor: [fillColor, "#d9d9d9"],
                borderWidth: 0
            }]
        },
        options: {
            responsive:true,
            maintainAspectRatio:false,
            rotation:-90,
            circumference:180,
            cutout:"68%",
            animation:false,
            plugins:{
                legend:{display:false},
                tooltip:{enabled:false}
            }
        }
    });
});
</script>